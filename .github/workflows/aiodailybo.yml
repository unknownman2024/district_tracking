name: Daily Boxoffice Auto Tracker

on:
  schedule:
    - cron: "30 * * * *"   # Runs at the 30th minute of every hour (UTC)
  workflow_dispatch:        # Manual trigger if needed

# prevent race conditions: only one run at a time
concurrency:
  group: boxoffice-tracker
  cancel-in-progress: false

jobs:
  track:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Install dependencies
        run: npm install --omit=dev

      - name: ğŸ§¹ Sync with Remote (reset before generation)
        run: |
          git fetch origin main
          git checkout main
          git reset --hard origin/main

      - name: ğŸš€ Run Daily Boxoffice Tracker
        run: |
          set -e
          node dailybo.js   # generates Daily Boxoffice/*.json files

      - name: ğŸ’¾ Commit & Safe Push JSON
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "Auto Tracker Bot"

          git add -f "Daily Boxoffice/"
          git commit -m "Auto update: $(date '+%Y-%m-%d %H:%M')" || exit 0

          # retry loop to avoid race condition errors
          for i in 1 2 3 4 5; do
            if git pull --rebase origin main && git push origin main; then
              echo "âœ… Push successful"
              break
            else
              echo "âš ï¸ Push failed, retrying ($i)..."
              sleep 5
            fi
          done
